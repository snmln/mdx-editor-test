import { useState } from 'react';
import { Meta, Story, Canvas, ArgsTable } from '@storybook/addon-docs';
import { eachDayOfInterval } from 'date-fns';
import { Button } from '@devseed-ui/button';
import {
  CollecticonCircleXmark,
  CollecticonCircleInformation
} from '@devseed-ui/collecticons';

import { formatDateLabel } from './utils';
import { DatePicker, Calendar, getTetherAttachments } from '.';

<Meta title='Components/Date Picker' />

# Date Picker

Displays a datepicker element. It can be used as to pick a single date or a date range.  
It has support for calendar view and direct input.

The picker has an internal state allowing the user to select or input the needed date.  
When the check-mark gets clicked the date selection is confirmed.

```
yarn add @devseed-ui/date-picker
```

```js
import { DatePicker, Calendar } from '@devseed-ui/date-picker';
```

export const baseViewOpts = {
  view: {
    name: 'view',
    type: { name: 'string', required: false },
    description:
      "Defines the view the calendar is displaying, not what the user is picking. For `month`, the month's days are displayed and the user picks one. For `year`, the month list is displayed and the user picks one, and so on.",
    defaultValue: 'month',
    table: {
      type: { summary: 'string' },
      defaultValue: { summary: 'month' }
    },
    control: {
      type: 'select'
    },
    options: ['month', 'year', 'decade']
  },
  isRange: {
    name: 'isRange',
    type: { name: 'boolean', required: false },
    description: 'Whether the picker should allow date range.',
    defaultValue: false,
    table: {
      type: { summary: 'boolean' },
      defaultValue: { summary: false }
    },
    control: {
      type: 'boolean'
    }
  }
};

export const baseCalendarProps = {
  ...baseViewOpts,
  value: {
    name: 'value',
    type: { name: 'object', required: true },
    description:
      'Value for the datepicker. The value will always be an object with `{start, end}`. If the value is not a range, both values will be the same.',
    table: {
      type: { summary: 'Object({ start: Date, end: Date })' }
    },
    control: {
      type: null
    }
  },
  min: {
    name: 'min',
    type: { name: 'Date', required: false },
    description: 'The minimum date that can be selected.',
    table: {
      type: { summary: 'Date' }
    },
    control: {
      type: 'date'
    }
  },
  max: {
    name: 'max',
    type: { name: 'Date', required: false },
    description: 'The maximum date that can be selected.',
    table: {
      type: { summary: 'Date' }
    },
    control: {
      type: 'date'
    }
  },
  datesToRestrict: {
    name: 'datesToRestrict',
    type: { name: 'Array', required: false },
    description:
      'List of dates to restrict the behavior of the calendar. These dates can be disabled or enabled depending on the value of `restrictMode`.',
    table: {
      type: { summary: 'Array of Dates' }
    },
    control: {
      type: null
    }
  },
  restrictMode: {
    name: 'restrictMode',
    type: { name: 'string', required: false },
    description:
      'Defines the behavior of the dates defined through the `datesToRestrict` property.',
    defaultValue: 'disable',
    table: {
      type: { summary: 'string' },
      defaultValue: { summary: 'disable' }
    },
    control: {
      type: 'select'
    },
    options: ['enable', 'disable']
  }
};

<Canvas>
  <Story
    name='Date Picker'
    argTypes={{
      ...baseCalendarProps,
      id: {
        name: 'id',
        type: { name: 'string', required: true },
        description: 'Sets the date picker ID',
        table: {
          type: { summary: 'string' }
        },
        control: {
          type: null
        }
      },
      direction: {
        name: 'direction',
        type: { name: 'string', required: false },
        description: `Sets opening direction of the date-picker.`,
        defaultValue: 'down',
        table: {
          type: { summary: 'string' },
          defaultValue: { summary: 'down' }
        },
        control: {
          type: 'select'
        },
        options: ['up', 'down', 'left', 'right']
      },
      alignment: {
        name: 'alignment',
        type: { name: 'string', required: false },
        description:
          'Sets the alignment of the date-picker box. `left`, `center`, `right` can only be used with `up`, `down` directions. `top`, `middle`, `bottom` can only be used with `left`, `right` directions.',
        defaultValue: 'center',
        table: {
          type: { summary: 'string' },
          defaultValue: { summary: 'center' }
        },
        control: {
          type: 'select'
        },
        options: ['left', 'center', 'right', 'top', 'middle', 'bottom']
      },
      isClearable: {
        name: 'isClearable',
        type: { name: 'boolean', required: false },
        description: 'Allows the selected date to be cleared',
        defaultValue: false,
        table: {
          type: { summary: 'boolean' },
          defaultValue: { summary: 'false' }
        },
        control: {
          type: 'boolean'
        }
      },
      classname: {
        name: 'classname',
        type: { name: 'string', required: false },
        description: 'Additional classnames for the date-picker content box',
        table: {
          type: { summary: 'string' }
        },
        control: {
          type: 'text'
        }
      },
      onConfirm: {
        name: 'onConfirm',
        type: { name: 'function', required: true },
        description:
          'Callback for when the date selection is confirmed. This is called with an object `{start: Date, end: Date}`. If not in range mode, both values will be the same.',
        table: {
          type: { summary: 'function' }
        },
        control: {
          type: null
        }
      },
      onCancel: {
        name: 'onCancel',
        type: { name: 'function', required: false },
        description:
          'Callback for when the date selection is cancelled. This is triggered when the X icon is clicked. The internal draft value is reset.',
        table: {
          type: { summary: 'function' }
        },
        control: {
          type: null
        }
      },
      onDateChange: {
        name: 'onDateChange',
        type: { name: 'function', required: false },
        description:
          'Callback for when the date selection changes. This is to be used if the draft date need to be controlled. This is called with an object `{start: Date, end: Date}`. If not in range mode, both values will be the same.',
        table: {
          type: { summary: 'function' }
        },
        control: {
          type: null
        }
      },
      renderTriggerElement: {
        name: 'renderTriggerElement',
        type: { name: 'function', required: false },
        description:
          'A function that returns a trigger element. The function is called with (props, label). The `props` must be spread onto the returning element.',
        table: {
          type: { summary: 'function' },
          defaultValue: {
            summary: '(props) => <Button {...props}>{label}</Button>'
          }
        },
        control: {
          type: null
        }
      },
      renderAdditionalContent: {
        name: 'renderAdditionalContent',
        type: { name: 'function', required: false },
        description:
          'Additional content to render after the calendar/direct input. The function receives props as argument: `{ tab: Current Tab }`',
        table: {
          type: { summary: 'function' }
        },
        control: {
          type: 'text'
        }
      }
    }}
  >
    {(args) => {
      const [value, setValue] = useState({ start: null, end: null });
      try {
        getTetherAttachments(args.direction, args.alignment);
        return (
          <DatePicker
            id='date-picker'
            value={value}
            onConfirm={setValue}
            isRange={args.isRange}
            view={args.view}
            min={args.min ? new Date(args.min) : null}
            max={args.max ? new Date(args.max) : null}
            direction={args.direction}
            alignment={args.alignment}
            isClearable={args.isClearable}
            classname={args.classname}
            renderAdditionalContent={() => args.renderAdditionalContent}
          />
        );
      } catch (e) {
        return <p>{e.message}</p>;
      }
    }}
  </Story>
</Canvas>

<ArgsTable story='Date Picker' />

## Demonstration of Draft state

<Canvas>
  <Story name='Draft state' argTypes={baseViewOpts}>
    {(args) => {
      const [state, setState] = useState({ start: null, end: null });
      const [draftState, setDraftState] = useState({ start: null, end: null });
      const opts = { view: args.view, isRange: args.isRange };
      return (
        <>
          <p>Confirmed state: {formatDateLabel(state, opts)}</p>
          <p>Draft state: {formatDateLabel(draftState, opts)}</p>
          <DatePicker
            id='date-picker-draft'
            value={state}
            onConfirm={setState}
            onDateChange={setDraftState}
            isRange={args.isRange}
            view={args.view}
          />
        </>
      );
    }}
  </Story>
</Canvas>

<ArgsTable story='Draft state' />

## Custom trigger

<Canvas>
  <Story name='Custom trigger'>
    {(args) => {
      const [state, setState] = useState({ start: null, end: null });
      return (
        <DatePicker
          id='date-picker-trigger'
          value={state}
          onConfirm={setState}
          renderTriggerElement={(props, label) => (
            <button {...props}>{label}</button>
          )}
        />
      );
    }}
  </Story>
</Canvas>

# Calendar

<Canvas>
  <Story
    name='Calendar'
    argTypes={{
      ...baseCalendarProps,
      onChange: {
        name: 'onChange',
        type: { name: 'function', required: true },
        description:
          'Callback for when the date is selected. This is called with an object `{start: Date, end: Date}`. If not in range mode, both values will be the same.',
        table: {
          type: { summary: 'function' }
        },
        control: {
          type: null
        }
      }
    }}
  >
    {(args) => {
      const [state, setState] = useState({ start: null, end: null });
      return (
        <Calendar
          value={state}
          onChange={setState}
          isRange={args.isRange}
          view={args.view}
          min={args.min ? new Date(args.min) : null}
          max={args.max ? new Date(args.max) : null}
        />
      );
    }}
  </Story>
</Canvas>

<ArgsTable story='Calendar' />

## Demonstration of restrictred dates

This example restricts the dates available either by enabling them or disabling them.

The `datesToRestrict` needs to be configured with daily dates. If you want to affect a whole month, you'll need to specify every single day. To help with this you can use the `eachDayOfInterval` helper from `date-fns`.  
This example is configured with the following dates:

```js
const datesToRestrict = [
  new Date('2022/05/20'),
  new Date('2022/05/22'),
  new Date('2022/05/25'),
  new Date('2026/01/01'),
  new Date('2022/06/01'),
  // The full month of june 2022
  ...eachDayOfInterval({
    start: new Date('2022/06/01'),
    end: new Date('2022/06/30')
  }),
  // The full year 2023
  ...eachDayOfInterval({
    start: new Date('2023/01/01'),
    end: new Date('2023/12/31')
  })
];
```

### Calendar

<Canvas>
  <Story name='Restricted dates on Calendar' argTypes={baseCalendarProps}>
    {(args) => {
      const [state, setState] = useState({ start: null, end: null });
      const datesToRestrict = [
        new Date('2022/05/20'),
        new Date('2022/05/22'),
        new Date('2022/05/25'),
        new Date('2026/01/01'),
        new Date('2022/06/01'),
        // The full month of june 2022
        ...eachDayOfInterval({
          start: new Date('2022/06/01'),
          end: new Date('2022/06/30')
        }),
        // The full year 2023
        ...eachDayOfInterval({
          start: new Date('2023/01/01'),
          end: new Date('2023/12/31')
        })
      ];
      return (
        <Calendar
          value={state}
          onChange={setState}
          isRange={args.isRange}
          view={args.view}
          min={args.min ? new Date(args.min) : null}
          max={args.max ? new Date(args.max) : null}
          datesToRestrict={datesToRestrict}
          restrictMode={args.restrictMode}
        />
      );
    }}
  </Story>
</Canvas>

<ArgsTable story='Restricted dates on Calendar' />

### Date Picker

<Canvas>
  <Story name='Restricted dates on Picker' argTypes={baseCalendarProps}>
    {(args) => {
      const [value, setValue] = useState({
        start: new Date('2022/05/10'),
        end: new Date('2022/05/10')
      });
      const datesToRestrict = [
        new Date('2022/05/20'),
        new Date('2022/05/22'),
        new Date('2022/05/25'),
        new Date('2026/01/01'),
        new Date('2022/06/01'),
        // The full month of june 2022
        ...eachDayOfInterval({
          start: new Date('2022/06/01'),
          end: new Date('2022/06/30')
        }),
        // The full year 2023
        ...eachDayOfInterval({
          start: new Date('2023/01/01'),
          end: new Date('2023/12/31')
        })
      ];
      return (
        <DatePicker
          id='date-picker-restrict'
          value={value}
          onConfirm={setValue}
          isRange={args.isRange}
          view={args.view}
          min={args.min ? new Date(args.min) : null}
          max={args.max ? new Date(args.max) : null}
          datesToRestrict={datesToRestrict}
          restrictMode={args.restrictMode}
        />
      );
    }}
  </Story>
</Canvas>

<ArgsTable story='Restricted dates on Picker' />
